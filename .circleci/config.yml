---
version: 2.1

orbs:
  node: circleci/node@1.1

composer_with_lowest_dependencies: &composer_with_lowest_dependencies
  run: |
    composer global require hirak/prestissimo --no-progress
    composer update --prefer-lowest --prefer-stable

composer: &composer
  run: |
    composer global require hirak/prestissimo --no-progress
    composer update

tests: &tests
  run: |
      composer test -vvv
      bin/doc
      composer run rector || (echo "Coding standards are not respected. Run 'composer run rector'" && exit 1)
      composer run php-cs-fixer || (echo "Coding standards are not respected. Run 'composer run php-cs-fixer'" && exit 1)

tests_with_future_mode: &tests_with_future_mode
  run: |
      PHP_CS_FIXER_FUTURE_MODE=1 composer test -vvv
      bin/doc
      composer run rector || (echo "Coding standards are not respected. Run 'composer run rector'" && exit 1)
      composer run php-cs-fixer || (echo "Coding standards are not respected. Run 'composer run php-cs-fixer'" && exit 1)

jobs:
  php-7-2:
    docker:
      - image: circleci/php:7.2
    steps:
      - checkout
      - <<: *composer
      - <<: *tests

  php-7-2-with-future-mode:
    docker:
      - image: circleci/php:7.2
    steps:
      - checkout
      - <<: *composer
      - <<: *tests_with_future_mode

  php-7-2-with-lowest-dependencies:
    docker:
      - image: circleci/php:7.2
    steps:
      - checkout
      - <<: *composer_with_lowest_dependencies
      - <<: *tests

  php-7-3:
    docker:
      - image: circleci/php:7.3
    steps:
      - checkout
      - <<: *composer
      - <<: *tests

  php-7-3-with-future-mode:
    docker:
      - image: circleci/php:7.3
    steps:
      - checkout
      - <<: *composer
      - <<: *tests_with_future_mode

  php-7-3-with-lowest-dependencies:
    docker:
      - image: circleci/php:7.3
    steps:
      - checkout
      - <<: *composer_with_lowest_dependencies
      - <<: *tests

  php-7-4:
    docker:
      - image: circleci/php:7.4
    steps:
      - checkout
      - <<: *composer
      - <<: *tests

  php-7-4-with-future-mode:
    docker:
      - image: circleci/php:7.4
    steps:
      - checkout
      - <<: *composer
      - <<: *tests_with_future_mode

  php-7-4-with-lowest-dependencies:
    docker:
      - image: circleci/php:7.4
    steps:
      - checkout
      - <<: *composer_with_lowest_dependencies
      - <<: *tests

  documentation:
    docker:
      - image: circleci/php:7.4
    steps:
      - checkout
      - <<: *composer
      - run: bin/doc > README.new.md
      - run: cmp --silent README.md README.new.md || cmp README.md README.new.md || (echo "Documentation is outdated. Run 'bin/doc > README.md'" && exit 1)

  release-test:
    executor:
      name: node/default
    steps:
      - node/install
      - checkout
      - node/with-cache:
          steps:
            - run: npm install
      - run: node_modules/.bin/semantic-release --dry-run

  release:
    executor:
      name: node/default
    steps:
      - node/install
      - checkout
      - node/with-cache:
          steps:
            - run: npm install
      - run: node_modules/.bin/semantic-release

workflows:
  version: 2
  PR:
    jobs:
      - documentation
      - php-7-2
      - php-7-2-with-future-mode:
          requires:
            - php-7-2
      - php-7-2-with-lowest-dependencies:
          requires:
            - php-7-2
      - php-7-3
      - php-7-3-with-future-mode:
          requires:
            - php-7-3
      - php-7-3-with-lowest-dependencies:
          requires:
            - php-7-3
      - php-7-4
      - php-7-4-with-future-mode:
          requires:
            - php-7-4
      - php-7-4-with-lowest-dependencies:
          requires:
            - php-7-4
      - release-test
      - release:
          requires:
            - release-test
            - documentation
            - php-7-2
            - php-7-2-with-future-mode
            - php-7-2-with-lowest-dependencies
            - php-7-3
            - php-7-3-with-future-mode
            - php-7-3-with-lowest-dependencies
            - php-7-4
            - php-7-4-with-future-mode
            - php-7-4-with-lowest-dependencies
          filters:
            branches:
              only:
                - master
